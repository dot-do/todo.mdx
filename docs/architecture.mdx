---
title: Architecture
description: How todo.mdx works under the hood
---

# Architecture

todo.mdx is a monorepo with packages for MDX compilation, a Cloudflare-native backend, and CLI tools.

## Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         todo.mdx.do                              │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Payload CMS   │  │    Dashboard    │  │     Worker      │  │
│  │                 │  │                 │  │                 │  │
│  │  - Admin UI     │  │  - Next.js 15   │  │  - API routes   │  │
│  │  - Collections  │  │  - shadcn/ui    │  │  - MCP server   │  │
│  │  - Access ctrl  │  │  - React 19     │  │  - Webhooks     │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │            │
│           └────────────────────┼────────────────────┘            │
│                                │                                 │
│                          ┌─────▼─────┐                          │
│                          │    D1     │                          │
│                          │ (SQLite)  │                          │
│                          └───────────┘                          │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Durable Objects                          ││
│  │                                                              ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ ││
│  │  │   Repo DO   │  │  Project DO │  │    Workflow DO      │ ││
│  │  │             │  │             │  │                     │ ││
│  │  │  Per-repo   │  │  Cross-repo │  │  Durable execution  │ ││
│  │  │  sync state │  │  coord      │  │  step.do/waitFor    │ ││
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘ ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          ▼                     ▼                     ▼
     ┌─────────┐          ┌──────────┐          ┌───────────┐
     │  beads  │          │  GitHub  │          │  Linear   │
     │ (local) │          │  Issues  │          │ (planned) │
     └─────────┘          └──────────┘          └───────────┘
```

## Monorepo Structure

```
todo.mdx/
├── apps/
│   └── todo.mdx.do/          # Payload CMS + Next.js dashboard
│       ├── src/
│       │   ├── app/          # Next.js app router
│       │   ├── collections/  # Payload collections
│       │   └── components/   # React components
│       └── payload.config.ts
│
├── packages/
│   ├── todo.mdx/             # Core: TODO.mdx → TODO.md
│   │   ├── src/
│   │   │   ├── compiler.ts   # MDX compilation
│   │   │   ├── parser.ts     # Parse .todo/*.md
│   │   │   ├── pattern.ts    # File naming patterns
│   │   │   └── cli.ts        # CLI commands
│   │   └── package.json
│   │
│   ├── roadmap.mdx/          # ROADMAP.mdx → ROADMAP.md
│   ├── cli.mdx/              # MDX-based CLI framework
│   ├── agents.mdx/           # AGENTS.mdx → CLAUDE.md
│   ├── claude.mdx/           # Claude Code dispatch CLI
│   └── readme.mdx/           # README.mdx → README.md
│
├── worker/                   # Cloudflare Worker
│   ├── src/
│   │   ├── index.ts          # Main entry
│   │   ├── api/              # REST API routes
│   │   ├── mcp/              # MCP server
│   │   ├── webhooks/         # GitHub webhook handlers
│   │   └── do/               # Durable Objects
│   └── wrangler.toml
│
└── docs/                     # Documentation (MDX)
```

## Data Flow

### Local → Cloud Sync

```
┌─────────────────────────────────────────────────────────────────┐
│                         Local Machine                            │
│                                                                  │
│  .beads/issues.jsonl                                             │
│         │                                                        │
│         │ bd sync                                                │
│         ▼                                                        │
│  Git commit/push                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ GitHub webhook
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    todo.mdx.do Worker                            │
│                                                                  │
│  1. Receive push event                                           │
│  2. Route to Repo Durable Object                                │
│  3. Parse changed files (.beads/, .todo/, TODO.mdx)             │
│  4. Sync to D1 via Payload                                      │
│  5. Update GitHub Issues if needed                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### GitHub → Local Sync

```
┌─────────────────────────────────────────────────────────────────┐
│                          GitHub                                  │
│                                                                  │
│  Issue created/updated/closed                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Webhook
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    todo.mdx.do Worker                            │
│                                                                  │
│  1. Receive issue event                                          │
│  2. Update D1 via Payload                                       │
│  3. Queue sync back to repo                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Git push (via GitHub API)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Local Machine                            │
│                                                                  │
│  git pull                                                        │
│         │                                                        │
│         ▼                                                        │
│  .beads/issues.jsonl updated                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Payload CMS

The admin interface and API layer, built on Payload with Cloudflare D1.

### Collections

```typescript
// Issues
{
  id: string
  title: string
  description: string
  status: 'open' | 'in_progress' | 'closed'
  priority: 0 | 1 | 2 | 3 | 4
  type: 'task' | 'bug' | 'feature' | 'epic'
  labels: string[]
  assignee: relationship('users')
  repo: relationship('repos')
  milestone: relationship('milestones')
  dependsOn: relationship('issues', hasMany)
  blocks: relationship('issues', hasMany)
  createdAt: date
  closedAt: date
}

// Repos
{
  id: string
  owner: string
  name: string
  fullName: string  // owner/name
  installationId: number  // GitHub App
  settings: json
}

// Milestones
{
  id: string
  title: string
  description: string
  dueDate: date
  repo: relationship('repos')
  issues: relationship('issues', hasMany)
}

// Users
{
  id: string
  email: string
  githubId: number
  githubUsername: string
}
```

### Workers RPC

The Worker accesses Payload via RPC binding:

```typescript
// worker/src/index.ts
export default {
  async fetch(request: Request, env: Env) {
    // Get Payload instance via RPC
    const payload = await env.PAYLOAD.payload()

    // Query issues
    const issues = await payload.find({
      collection: 'issues',
      where: { status: { equals: 'open' } }
    })

    return Response.json(issues)
  }
}
```

## Durable Objects

### Repo DO

Per-repository state and sync coordination:

```typescript
export class RepoDO extends DurableObject {
  // Sync state machine (XState)
  private syncMachine: StateMachine

  // Handle incoming events
  async handlePush(payload: PushEvent) {
    // Parse changed files
    const changes = await this.parseChanges(payload.commits)

    // Route to appropriate handlers
    if (changes.beads) await this.syncBeads(changes.beads)
    if (changes.todo) await this.syncTodo(changes.todo)
    if (changes.roadmap) await this.syncRoadmap(changes.roadmap)
  }

  async handleIssue(payload: IssueEvent) {
    // Sync GitHub issue to D1 and beads
  }
}
```

### Project DO

Cross-repository coordination:

```typescript
export class ProjectDO extends DurableObject {
  // Coordinate multi-repo projects
  async getProjectStatus(repoIds: string[]) {
    // Aggregate stats across repos
  }
}
```

### Workflow DO

Durable workflow execution:

```typescript
export class WorkflowDO extends DurableObject {
  async run(event: WorkflowEvent, step: WorkflowStep) {
    // Execute workflow with durability
    const result = await step.do('spawn-claude', () =>
      this.spawnClaude(event.issue)
    )

    // Wait for external event (can be days)
    await step.waitForEvent('pr-approved', {
      timeout: '7 days'
    })

    // Continue execution
    await step.do('merge', () =>
      this.mergePR(result.pr)
    )
  }
}
```

## Authentication

### oauth.do

OAuth flow for CLI tools:

```typescript
import { ensureLoggedIn } from 'oauth.do/node'

// CLI auth
const user = await ensureLoggedIn({
  provider: 'github',
  scopes: ['repo', 'read:org']
})
```

### WorkOS Vault

Secure token storage:

```typescript
// Store tokens after auth
await workos.vault.store(userId, {
  github_token: ghToken,
  claude_jwt: claudeJwt
})

// Retrieve for workflow execution
const tokens = await workos.vault.get(userId)
```

### GitHub App

Webhook authentication and API access:

```typescript
// Verify webhook signature
const isValid = await verifyWebhookSignature(
  request,
  env.GITHUB_WEBHOOK_SECRET
)

// Get installation token
const octokit = await getInstallationOctokit(
  installationId,
  env.GITHUB_APP_PRIVATE_KEY
)
```

## MCP Server

Model Context Protocol server for AI assistants:

```typescript
// worker/src/mcp/index.ts
export const mcpServer = {
  tools: {
    listIssues: {
      description: 'List issues with optional filters',
      parameters: {
        status: { type: 'string', enum: ['open', 'closed', 'all'] },
        priority: { type: 'number', min: 0, max: 4 },
        limit: { type: 'number', default: 10 }
      },
      handler: async (params, env) => {
        const payload = await env.PAYLOAD.payload()
        return payload.find({
          collection: 'issues',
          where: buildQuery(params)
        })
      }
    },

    createIssue: { /* ... */ },
    updateIssue: { /* ... */ },
    closeIssue: { /* ... */ },
    search: { /* ... */ }
  }
}
```

## MDX Compilation

### Pipeline

```
TODO.mdx
    │
    │ 1. Parse MDX
    ▼
┌─────────────────┐
│   mdxld parse   │
│                 │
│  - Frontmatter  │
│  - AST          │
│  - Components   │
└────────┬────────┘
         │
         │ 2. Fetch data
         ▼
┌─────────────────┐
│  Data sources   │
│                 │
│  - beads        │
│  - GitHub       │
│  - API          │
└────────┬────────┘
         │
         │ 3. Render components
         ▼
┌─────────────────┐
│   Component     │
│   rendering     │
│                 │
│  <Issues.Ready/>│
│       ↓         │
│  - [ ] task 1   │
│  - [ ] task 2   │
└────────┬────────┘
         │
         │ 4. Output markdown
         ▼
    TODO.md
```

### Component Rendering

```typescript
// packages/todo.mdx/src/components/Issues.tsx
export const Issues = {
  Ready: ({ limit, priority }) => {
    const issues = useIssues({
      status: 'open',
      blocked: false,
      priority,
      limit
    })

    return issues.map(issue => (
      <Issue key={issue.id} {...issue} />
    ))
  },

  Blocked: ({ limit }) => {
    const issues = useIssues({
      blocked: true,
      limit
    })

    return issues.map(issue => (
      <>
        <Issue key={issue.id} {...issue} />
        <Blockers issue={issue} />
      </>
    ))
  }
}
```

## Deployment

### Cloudflare Resources

| Resource | Purpose |
|----------|---------|
| Worker | API, MCP, webhooks |
| D1 | SQLite database |
| R2 | File storage |
| Durable Objects | Stateful coordination |
| Workflows | Durable execution |

### Environment Variables

```bash
# GitHub App
GITHUB_APP_ID=
GITHUB_APP_PRIVATE_KEY=
GITHUB_WEBHOOK_SECRET=

# OAuth
WORKOS_API_KEY=
WORKOS_CLIENT_ID=

# Database
DATABASE_URL=  # D1 binding

# Claude (for workflows)
ANTHROPIC_API_KEY=
```

## Next Steps

- [Getting Started](/docs/getting-started) — Quick start guide
- [API Reference](/docs/api) — REST and MCP endpoints
- [Workflows](/docs/agents-workflows) — Autonomous development
- [Deployment](/docs/deployment) — Self-hosting guide
