<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code - todo.mdx</title>
  <link rel="stylesheet" href="/assets/terminal.css">
  <style>
    #terminal-container {
      position: fixed;
      top: 36px; /* Space for header */
      left: 0;
      right: 0;
      bottom: 24px; /* Space for status bar */
    }
  </style>
</head>
<body>
  <div id="header-bar" class="header-bar">
    <span class="repo-name" id="repo-name">Loading...</span>
    <span class="branch" id="branch-name"></span>
  </div>

  <div id="terminal-container"></div>
  <div id="status-bar" class="status-bar">Initializing...</div>

  <!-- Auth overlay -->
  <div id="auth-overlay" class="auth-overlay" style="display: none;">
    <h2>Authentication Required</h2>
    <p style="color: #888;">Sign in to access Claude Code</p>
    <button onclick="signIn()">Sign in with GitHub</button>
  </div>

  <script src="/assets/terminal.js"></script>
  <script>
    // Parse repo info from URL path: /code/:org/:repo(/:ref)?
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    // Expected: ['code', 'org', 'repo'] or ['code', 'org', 'repo', 'ref']
    const org = pathParts[1] || '';
    const repoName = pathParts[2] || '';
    const ref = pathParts[3] || 'main';
    const fullName = org && repoName ? `${org}/${repoName}` : '';

    const params = new URLSearchParams(window.location.search);
    let sessionId = params.get('session');
    const task = params.get('task') || 'Help with development tasks in this repository';

    let terminal = null;

    // Update header
    function updateHeader() {
      document.getElementById('repo-name').textContent = fullName || 'Unknown Repository';
      document.getElementById('branch-name').textContent = ref ? `@ ${ref}` : '';
      document.title = fullName ? `${fullName} - Claude Code` : 'Claude Code';
    }

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        if (response.ok) {
          return await response.json();
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Get session token for WebSocket
    async function getToken() {
      try {
        const response = await fetch('/api/auth/token', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          return data.token;
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Sign in redirect
    function signIn() {
      const returnUrl = encodeURIComponent(window.location.href);
      window.location.href = `/api/auth/login?return=${returnUrl}`;
    }

    // Start Claude Code session
    async function startSession() {
      if (!fullName) {
        terminal.write('\x1b[31mError: Invalid URL. Use /code/owner/repo\x1b[0m\r\n');
        return null;
      }

      terminal.write(`\x1b[34mStarting Claude Code for ${fullName}...\x1b[0m\r\n`);
      if (ref !== 'main') {
        terminal.write(`\x1b[34mBranch: ${ref}\x1b[0m\r\n`);
      }

      try {
        const response = await fetch(`/api/code/${org}/${repoName}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ task, ref })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || error.message || 'Failed to start session');
        }

        const data = await response.json();
        sessionId = data.sessionId;

        // Update URL with session ID
        const url = new URL(window.location);
        url.searchParams.set('session', sessionId);
        window.history.replaceState({}, '', url);

        terminal.write(`\x1b[32m✓ Session started: ${sessionId.slice(0, 8)}...\x1b[0m\r\n\r\n`);

        return data.sessionId;
      } catch (e) {
        terminal.write(`\x1b[31mError: ${e.message}\x1b[0m\r\n`);

        if (e.message.includes('not found') || e.message.includes('Install')) {
          terminal.write('\r\n\x1b[33mThe GitHub App may not be installed for this repository.\x1b[0m\r\n');
          terminal.write('\x1b[33mInstall it at: https://github.com/apps/todo-mdx\x1b[0m\r\n');
        }

        return null;
      }
    }

    // Connect to session via WebSocket
    async function connectToSession(sid) {
      const token = await getToken();
      if (!token) {
        document.getElementById('auth-overlay').style.display = 'flex';
        return;
      }

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/api/terminal/${sid}?token=${encodeURIComponent(token)}`;

      try {
        await terminal.connect(wsUrl);
      } catch (e) {
        terminal.write(`\x1b[31mConnection failed: ${e.message}\x1b[0m\r\n`);
      }
    }

    // Initialize
    async function init() {
      updateHeader();

      // Validate URL
      if (!fullName) {
        document.getElementById('repo-name').textContent = 'Invalid URL';
        document.getElementById('status-bar').textContent = 'Error: Invalid URL';
        document.getElementById('status-bar').className = 'status-bar error';
        return;
      }

      // Create terminal
      terminal = new TerminalWidget({
        containerId: 'terminal-container',
        statusBarId: 'status-bar',
        onComplete: (exitCode) => {
          terminal.write(`\r\n\x1b[${exitCode === 0 ? '32' : '31'}mSession ended with exit code: ${exitCode}\x1b[0m\r\n`);
        }
      });

      await terminal.init();

      // Check auth
      const user = await checkAuth();
      if (!user) {
        document.getElementById('auth-overlay').style.display = 'flex';
        return;
      }

      terminal.write(`\x1b[32m● Authenticated as ${user.email || user.name}\x1b[0m\r\n`);

      // Start or connect to session
      if (sessionId) {
        terminal.write(`\x1b[34mConnecting to session ${sessionId.slice(0, 8)}...\x1b[0m\r\n`);
        await connectToSession(sessionId);
      } else {
        sessionId = await startSession();
        if (sessionId) {
          await connectToSession(sessionId);
        }
      }
    }

    // Start
    init().catch(console.error);
  </script>
</body>
</html>
