<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser Session - todo.mdx</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 500;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.running {
      background: rgba(56, 139, 253, 0.1);
      color: #58a6ff;
    }

    .status-badge.completed {
      background: rgba(63, 185, 80, 0.1);
      color: #3fb950;
    }

    .status-badge.error {
      background: rgba(248, 81, 73, 0.1);
      color: #f85149;
    }

    .status-badge.pending {
      background: rgba(187, 128, 9, 0.1);
      color: #d29922;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-badge.running .status-dot {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .browser-frame {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }

    .message-box {
      text-align: center;
      max-width: 400px;
    }

    .message-box h2 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .message-box p {
      color: #8b949e;
      margin-bottom: 16px;
    }

    .message-box .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }

    .btn:hover {
      background: #2ea043;
    }

    .btn.secondary {
      background: #21262d;
      border: 1px solid #30363d;
    }

    .btn.secondary:hover {
      background: #30363d;
    }

    #player-container {
      width: 100%;
      max-width: 1200px;
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      z-index: 100;
    }

    .session-info {
      font-size: 12px;
      color: #8b949e;
    }

    .error-details {
      background: #21262d;
      padding: 12px 16px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      color: #f85149;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Browser Session</h1>
    <div id="status-badge" class="status-badge pending">
      <span class="status-dot"></span>
      <span id="status-text">Loading...</span>
    </div>
  </header>

  <main class="content" id="content">
    <div class="message-box">
      <div class="icon">...</div>
      <h2>Loading session</h2>
      <p>Fetching session status...</p>
    </div>
  </main>

  <!-- Auth overlay -->
  <div id="auth-overlay" class="auth-overlay" style="display: none;">
    <h2>Authentication Required</h2>
    <p style="color: #8b949e;">Sign in to access browser sessions</p>
    <button class="btn" onclick="signIn()">Sign in with GitHub</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session');
    const org = params.get('org');
    const repo = params.get('repo');
    const issue = params.get('issue');

    let pollInterval = null;

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        return response.ok ? await response.json() : null;
      } catch (e) {
        return null;
      }
    }

    // Sign in redirect
    function signIn() {
      const returnUrl = encodeURIComponent(window.location.href);
      window.location.href = `/api/auth/login?return=${returnUrl}`;
    }

    // Fetch session status
    async function fetchSession() {
      let url;
      if (sessionId) {
        url = `/api/browser/${encodeURIComponent(sessionId)}`;
      } else if (org && repo && issue) {
        url = `/api/browser/${org}/${repo}/${issue}`;
      } else {
        return null;
      }

      try {
        const response = await fetch(url, { credentials: 'include' });
        if (response.ok) {
          return await response.json();
        }
        if (response.status === 404) {
          return { error: 'session_not_found' };
        }
        return { error: 'fetch_failed' };
      } catch (e) {
        return { error: e.message };
      }
    }

    // Update UI based on session state
    function updateUI(data) {
      const content = document.getElementById('content');
      const statusBadge = document.getElementById('status-badge');
      const statusText = document.getElementById('status-text');

      if (data.error) {
        statusBadge.className = 'status-badge error';
        statusText.textContent = 'Error';
        stopPolling();

        if (data.error === 'session_not_found') {
          content.innerHTML = `
            <div class="message-box">
              <div class="icon">?</div>
              <h2>Session Not Found</h2>
              <p>This browser session doesn't exist or has expired.</p>
              <a href="/browse" class="btn secondary">Start New Session</a>
            </div>
          `;
        } else {
          content.innerHTML = `
            <div class="message-box">
              <div class="icon">!</div>
              <h2>Error Loading Session</h2>
              <p>Failed to fetch session data.</p>
              <div class="error-details">${escapeHtml(data.error)}</div>
              <button class="btn secondary" onclick="location.reload()">Retry</button>
            </div>
          `;
        }
        return;
      }

      const session = data.session;
      const recording = data.recording;

      // Update status badge
      statusBadge.className = `status-badge ${session.status}`;
      statusText.textContent = formatStatus(session.status);

      switch (session.status) {
        case 'pending':
          content.innerHTML = `
            <div class="message-box">
              <div class="icon">...</div>
              <h2>Session Starting</h2>
              <p>Browser session is initializing...</p>
              <div class="session-info">Session ID: ${escapeHtml(session.id)}</div>
            </div>
          `;
          break;

        case 'running':
          if (session.provider === 'browserbase' && session.debuggerUrl) {
            // Browserbase with live debug view
            content.innerHTML = `
              <iframe
                class="browser-frame"
                src="${escapeHtml(session.debuggerUrl)}"
                allow="fullscreen"
              ></iframe>
            `;
          } else {
            // Cloudflare or no debug URL
            content.innerHTML = `
              <div class="message-box">
                <div class="icon">*</div>
                <h2>Session Active</h2>
                <p>Browser session is running. ${session.provider === 'cloudflare'
                  ? 'Cloudflare Browser Rendering does not support live preview.'
                  : 'Live preview not available.'}</p>
                <div class="session-info">
                  Provider: ${escapeHtml(session.provider)}<br>
                  Session ID: ${escapeHtml(session.id)}
                </div>
              </div>
            `;
          }
          break;

        case 'completed':
          stopPolling();
          if (recording && recording.length > 0) {
            content.innerHTML = '<div id="player-container"></div>';
            renderRecording(recording);
          } else {
            content.innerHTML = `
              <div class="message-box">
                <div class="icon">+</div>
                <h2>Session Completed</h2>
                <p>${session.provider === 'cloudflare'
                  ? 'Cloudflare Browser Rendering does not support session recording.'
                  : 'No recording available for this session.'}</p>
                <div class="session-info">Session ID: ${escapeHtml(session.id)}</div>
              </div>
            `;
          }
          break;

        case 'error':
          stopPolling();
          content.innerHTML = `
            <div class="message-box">
              <div class="icon">x</div>
              <h2>Session Error</h2>
              <p>The browser session encountered an error.</p>
              <div class="session-info">Session ID: ${escapeHtml(session.id)}</div>
            </div>
          `;
          break;

        case 'timed_out':
          stopPolling();
          if (recording && recording.length > 0) {
            content.innerHTML = '<div id="player-container"></div>';
            renderRecording(recording);
          } else {
            content.innerHTML = `
              <div class="message-box">
                <div class="icon">-</div>
                <h2>Session Timed Out</h2>
                <p>The browser session has expired.</p>
                <div class="session-info">Session ID: ${escapeHtml(session.id)}</div>
              </div>
            `;
          }
          break;
      }
    }

    // Render rrweb recording
    function renderRecording(events) {
      const container = document.getElementById('player-container');
      if (!container || !window.rrwebPlayer) return;

      new rrwebPlayer({
        target: container,
        props: {
          events: events,
          width: container.clientWidth,
          height: Math.min(600, window.innerHeight - 150),
          autoPlay: false,
        }
      });
    }

    // Format status for display
    function formatStatus(status) {
      const labels = {
        pending: 'Starting',
        running: 'Live',
        completed: 'Completed',
        error: 'Error',
        timed_out: 'Expired'
      };
      return labels[status] || status;
    }

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // Polling
    function startPolling() {
      if (pollInterval) return;
      pollInterval = setInterval(async () => {
        const data = await fetchSession();
        if (data) updateUI(data);
      }, 3000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    // Initialize
    async function init() {
      // Check if we have a session to display
      if (!sessionId && !(org && repo && issue)) {
        document.getElementById('content').innerHTML = `
          <div class="message-box">
            <div class="icon">?</div>
            <h2>No Session Specified</h2>
            <p>Provide a session ID or issue reference to view a browser session.</p>
            <div class="session-info">
              Examples:<br>
              ?session=browser:abc123<br>
              ?org=owner&repo=repo&issue=123
            </div>
          </div>
        `;
        return;
      }

      // Check auth
      const user = await checkAuth();
      if (!user) {
        document.getElementById('auth-overlay').style.display = 'flex';
        return;
      }

      // Fetch initial status
      const data = await fetchSession();
      if (data) {
        updateUI(data);

        // Start polling for pending/running sessions
        if (data.session && ['pending', 'running'].includes(data.session.status)) {
          startPolling();
        }
      }
    }

    // Start
    init().catch(console.error);

    // Cleanup on unload
    window.addEventListener('beforeunload', stopPolling);
  </script>
</body>
</html>
