{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "todo-mdx",
  "account_id": "b6641681fe423910342b9ffa1364c76d", // .do account

  // Use custom build output (with import.meta.url polyfill)
  "main": "dist/index.js",

  // Custom build command for import.meta.url polyfill
  "build": {
    "command": "node build.mjs"
  },

  // Skip wrangler bundling since we do our own
  "no_bundle": true,

  "compatibility_date": "2025-08-15",
  "compatibility_flags": [
    "nodejs_compat",
    "global_fetch_strictly_public"
  ],

  // Bundle configuration - shim packages for Workers compatibility
  "alias": {
    "file-type": "./shims/file-type.js",
    "undici": "./shims/undici.js"
  },

  // Static assets from public/ directory
  // run_worker_first: true ensures worker code runs for auth before serving assets
  "assets": {
    "directory": "./public",
    "binding": "ASSETS",
    "html_handling": "none",
    "not_found_handling": "none"
  },

  // Custom domain routes - MCP OAuth at root, API under paths
  "routes": [
    { "pattern": "todo.mdx.do/.well-known/*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/authorize*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/token*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/register*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/callback*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/sse*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/mcp*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/api/*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/github/*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/terminal*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/terminal.html", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/code/*", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/code.html", "zone_name": "mdx.do" },
    { "pattern": "todo.mdx.do/assets/*", "zone_name": "mdx.do" }
  ],

  // Workers AI for voice and embeddings
  "ai": {
    "binding": "AI"
  },

  // Vectorize for semantic search
  "vectorize": [
    {
      "binding": "VECTORIZE",
      "index_name": "todo-embeddings"
    }
  ],

  // D1 Database for app installs and DO registry
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "todo-mdx",
      "database_id": "7773cb8c-af79-4ae9-8473-342acbbc0444",
      "migrations_dir": "migrations"
    }
  ],

  // Containers - Claude Code sandbox
  "containers": [
    {
      "class_name": "ClaudeSandbox",
      "image": "./Dockerfile.claude",
      "instance_type": "basic",
      "max_instances": 10
    }
  ],

  // Durable Objects
  "durable_objects": {
    "bindings": [
      { "name": "REPO", "class_name": "RepoDO" },
      { "name": "PROJECT", "class_name": "ProjectDO" },
      { "name": "PRDO", "class_name": "PRDO" },
      { "name": "SESSION", "class_name": "SessionDO" },
      { "name": "MCP_OBJECT", "class_name": "TodoMCP" },
      { "name": "CLAUDE_SANDBOX", "class_name": "ClaudeSandbox" }
    ]
  },

  "migrations": [
    {
      "tag": "v1",
      "new_sqlite_classes": ["RepoDO", "ProjectDO"]
    },
    {
      "tag": "v2",
      "new_sqlite_classes": ["TodoMCP"]
    },
    {
      "tag": "v3",
      "new_sqlite_classes": ["ClaudeSandbox"]
    },
    {
      "tag": "v4",
      "new_sqlite_classes": ["PRDO"]
    },
    {
      "tag": "v5",
      "new_sqlite_classes": ["SessionDO"]
    }
  ],

  // Cloudflare Workflows
  "workflows": [
    {
      "binding": "DEVELOP_WORKFLOW",
      "name": "develop-workflow",
      "class_name": "DevelopWorkflow"
    },
    {
      "binding": "EMBED_WORKFLOW",
      "name": "embed-workflow",
      "class_name": "EmbedWorkflow"
    },
    {
      "binding": "BULK_EMBED_WORKFLOW",
      "name": "bulk-embed-workflow",
      "class_name": "BulkEmbedWorkflow"
    }
  ],

  // KV namespace for MCP OAuth state (sessions moved to SessionDO)
  "kv_namespaces": [
    {
      "binding": "OAUTH_KV",
      "id": "5602c4ff6e3249b684e5c8eaea0b1901"
    }
  ],

  // Environment variables (set via wrangler secret)
  // GitHub App: GITHUB_APP_ID, GITHUB_PRIVATE_KEY, GITHUB_WEBHOOK_SECRET
  // WorkOS AuthKit: WORKOS_CLIENT_ID, WORKOS_CLIENT_SECRET, COOKIE_ENCRYPTION_KEY
  // Payload: PAYLOAD_SECRET (shared with admin worker)
  // AI: ANTHROPIC_API_KEY
}
