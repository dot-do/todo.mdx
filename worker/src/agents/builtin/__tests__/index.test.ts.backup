import { describe, it, expect } from 'vitest'
import { builtinAgents, getBuiltinAgent, getBuiltinAgentIds } from '../index'

describe('builtin agents', () => {
  it('should have exactly 8 agents', () => {
    expect(builtinAgents).toHaveLength(8)
  })

  it('should have correct agent IDs', () => {
    const ids = getBuiltinAgentIds()
    expect(ids).toEqual(['priya', 'reed', 'benny', 'cody', 'dana', 'tom', 'sam', 'fiona'])
  })

  it('should find agent by id', () => {
    const priya = getBuiltinAgent('priya')
    expect(priya).toBeDefined()
    expect(priya?.name).toBe('Product Priya')
    expect(priya?.tier).toBe('light')
    expect(priya?.model).toBe('fast')
  })

  it('should return undefined for unknown agent', () => {
    const unknown = getBuiltinAgent('unknown')
    expect(unknown).toBeUndefined()
  })

  it('should have all required fields', () => {
    builtinAgents.forEach(agent => {
      expect(agent.id).toBeTruthy()
      expect(agent.name).toBeTruthy()
      expect(agent.description).toBeTruthy()
      expect(agent.tools).toBeInstanceOf(Array)
      expect(agent.tools.length).toBeGreaterThan(0)
      expect(['light', 'worker', 'sandbox']).toContain(agent.tier)
      expect(agent.model).toBeTruthy()
      expect(['ai-sdk', 'claude-agent-sdk', 'openai-agents', 'claude-code']).toContain(agent.framework)
      expect(agent.instructions).toBeTruthy()
    })
  })

  it('should have correct tiers', () => {
    expect(getBuiltinAgent('priya')?.tier).toBe('light')
    expect(getBuiltinAgent('reed')?.tier).toBe('light')
    expect(getBuiltinAgent('benny')?.tier).toBe('light')
    expect(getBuiltinAgent('cody')?.tier).toBe('worker')
    expect(getBuiltinAgent('dana')?.tier).toBe('worker')
    expect(getBuiltinAgent('tom')?.tier).toBe('worker')
    expect(getBuiltinAgent('sam')?.tier).toBe('worker')
    expect(getBuiltinAgent('fiona')?.tier).toBe('sandbox')
  })

  it('should have correct frameworks', () => {
    expect(getBuiltinAgent('priya')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('reed')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('benny')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('cody')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('dana')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('tom')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('sam')?.framework).toBe('ai-sdk')
    expect(getBuiltinAgent('fiona')?.framework).toBe('claude-code')
  })

  it('should have correct models', () => {
    expect(getBuiltinAgent('priya')?.model).toBe('fast')
    expect(getBuiltinAgent('reed')?.model).toBe('fast')
    expect(getBuiltinAgent('benny')?.model).toBe('overall')
    expect(getBuiltinAgent('cody')?.model).toBe('claude-sonnet-4-5')
    expect(getBuiltinAgent('dana')?.model).toBe('overall')
    expect(getBuiltinAgent('tom')?.model).toBe('claude-sonnet-4-5')
    expect(getBuiltinAgent('sam')?.model).toBe('claude-sonnet-4-5')
    expect(getBuiltinAgent('fiona')?.model).toBe('best')
  })

  describe('Coder Cody', () => {
    const cody = getBuiltinAgent('cody')

    it('should have all required integrations', () => {
      expect(cody).toBeDefined()
      expect(cody?.tools).toContain('github.*')
      expect(cody?.tools).toContain('linear.*')
      expect(cody?.tools).toContain('slack.*')
    })

    it('should have access to all source file operations', () => {
      expect(cody?.tools).toContain('file.*')
      expect(cody?.tools).toContain('code.*')
      expect(cody?.tools).toContain('git.*')
    })

    it('should use claude-sonnet model', () => {
      expect(cody?.model).toBe('claude-sonnet-4-5')
    })

    it('should have instructions covering autonomy levels', () => {
      expect(cody?.instructions).toContain('Full')
      expect(cody?.instructions).toContain('Assisted')
      expect(cody?.instructions).toContain('Supervised')
    })

    it('should have coding best practices in instructions', () => {
      expect(cody?.instructions).toContain('clean')
      expect(cody?.instructions).toContain('test')
      expect(cody?.instructions).toContain('TypeScript strict mode')
      expect(cody?.instructions).toContain('conventional commits')
    })
  })

  describe('TypeScript Tom', () => {
    const tom = getBuiltinAgent('tom')

    it('should be defined with correct name', () => {
      expect(tom).toBeDefined()
      expect(tom?.name).toBe('Typescript Tom')
    })

    it('should have npm and file capabilities', () => {
      expect(tom?.tools).toContain('github.*')
      expect(tom?.tools).toContain('npm.*')
      expect(tom?.tools).toContain('file.*')
      expect(tom?.tools).toContain('code.*')
      expect(tom?.tools).toContain('git.*')
    })

    it('should be worker tier', () => {
      expect(tom?.tier).toBe('worker')
    })

    it('should use claude-sonnet-4-5 model', () => {
      expect(tom?.model).toBe('claude-sonnet-4-5')
    })

    it('should use ai-sdk framework', () => {
      expect(tom?.framework).toBe('ai-sdk')
    })

    it('should have TypeScript-specific instructions', () => {
      expect(tom?.instructions).toContain('TypeScript')
      expect(tom?.instructions).toContain('strict mode')
    })

    it('should cover type system best practices', () => {
      expect(tom?.instructions).toContain('type inference')
      expect(tom?.instructions).toContain('generic')
    })

    it('should cover interface vs type usage', () => {
      expect(tom?.instructions).toContain('interface')
      expect(tom?.instructions).toContain('type')
    })

    it('should cover discriminated unions', () => {
      expect(tom?.instructions).toContain('discriminated union')
    })

    it('should cover module patterns', () => {
      expect(tom?.instructions).toContain('module')
      expect(tom?.instructions).toContain('export')
    })

    it('should cover tsconfig optimization', () => {
      expect(tom?.instructions).toContain('tsconfig')
    })
  })
})
