# Claude Code Sandbox Container
#
# Provides isolated environment for running Claude Code agents.
# Used by ClaudeSandbox Durable Object for automated development tasks.
#
# Includes:
# - Claude Code CLI for AI-assisted development
# - stdio-ws server for terminal WebSocket bridge
# - Git, curl, and common dev tools
#
# Security: Runs as non-root user 'sandbox' (uid 1000)

FROM docker.io/cloudflare/sandbox:0.6.7

# Create non-root user for security
# Using uid/gid 1000 which is standard for first non-root user
RUN groupadd -g 1000 sandbox && \
    useradd -u 1000 -g sandbox -m -s /bin/bash sandbox && \
    mkdir -p /home/sandbox/.npm-global && \
    chown -R sandbox:sandbox /home/sandbox

# Install Claude Code CLI globally (as root, then fix permissions)
RUN npm install -g @anthropic-ai/claude-code

# Set up workspace directory with correct ownership
RUN mkdir -p /workspace && chown -R sandbox:sandbox /workspace

# Copy stdio WebSocket server
COPY --chown=sandbox:sandbox sandbox/stdio-ws.ts /workspace/stdio-ws.ts

# Copy startup script (needs to be executable by sandbox user)
COPY sandbox/startup.sh /container-server/startup.sh
RUN chmod +x /container-server/startup.sh

# Extend command timeout for complex tasks (10 minutes)
ENV COMMAND_TIMEOUT_MS=600000

# Set npm global directory for non-root user
ENV NPM_CONFIG_PREFIX=/home/sandbox/.npm-global
ENV PATH="/home/sandbox/.npm-global/bin:$PATH"

# Switch to non-root user
USER sandbox
WORKDIR /workspace

# Port for stdio-ws bridge
EXPOSE 8080

# Port for any other services
EXPOSE 3000
